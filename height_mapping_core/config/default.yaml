# Unified Configuration for Height Mapping System
# This file contains both core engine and pipeline configuration

engine:
  map:
    width: 15.0           # Map width in meters
    height: 15.0          # Map height in meters
    resolution: 0.1       # Map resolution in meters per cell
    frame_id: "map"       # Map coordinate frame
    robot_centric: true   # Move map with robot
    update_mode: "continuous"  # continuous, threshold, centered, fixed
    update_threshold: 2.0      # Threshold for map update (meters)

  runtime:
    thread_safe: true           # Enable thread-safe operations
    reset_on_error: false       # Reset on pipeline errors
    enable_statistics: false    # Enable statistics collection

pipeline:
  stop_on_error: true  # Stop pipeline execution on stage error

  stages:
    # Update map origin to follow robot
    - name: "MapOriginUpdate"
      enabled: true
      params:
        update_mode: "continuous"
        update_threshold: 2.0
        robot_frame: "base_link"
        map_frame: "map"

    # Transform point cloud to base frame for filtering
    - name: "PointCloudTransform"
      enabled: true
      params:
        target_frame: "base_link"

    # Downsample point cloud using voxel grid
    - name: "VoxelFilter"
      enabled: true
      params:
        voxel_size: 0.05          # 5cm voxels
        reduction_method: "centroid"  # centroid, random, or center

    # Filter points by distance and height
    - name: "PassthroughFilter"
      enabled: true
      params:
        x_min: -10.0
        x_max: 10.0
        y_min: -10.0
        y_max: 10.0
        z_min: -0.1
        z_max: 2.0

    # Transform to map frame for height estimation
    - name: "PointCloudTransform"
      enabled: true
      params:
        target_frame: "map"

    # Raycasting for ground correction (optional)
    - name: "Raycasting"
      enabled: false
      params:
        max_ground_angle: -5.0     # degrees
        correction_threshold: 0.02  # 2cm
        enable_correction: true
        ray_length: 5.0

    # Height estimation
    - name: "HeightEstimation"
      enabled: true
      params:
        estimator_type: "incremental_mean"  # incremental_mean, kalman_filter, moving_average
        # Kalman filter specific parameters
        process_noise: 0.01
        measurement_noise: 0.05
        # Moving average specific parameters
        window_size: 10

    # # Multi-sensor synchronization (optional)
    # - name: "MultiSensorSync"
    #   enabled: false
    #   params:
    #     sync_tolerance: 0.1  # seconds
    #     min_sensors: 1
    #     max_sensors: 3

    # # Global mapping (optional)
    # - name: "GlobalMapping"
    #   enabled: false
    #   params:
    #     global_map_width: 100.0
    #     global_map_height: 100.0
    #     global_map_resolution: 0.2
    #     merge_threshold: 0.5